#!/bin/bash

# =============================================================================
# ğŸ“Š ì§„í–‰ ìƒí™© ì‹¤ì‹œê°„ ì—…ë°ì´í„°
# update_progress.sh
# ìƒˆë¡œìš´ íŒŒì¼ì„ ì¶”ê°€í•  ë•Œë§ˆë‹¤ ì§„í–‰ ìƒí™©ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í—¬í¼ ìŠ¤í¬ë¦½íŠ¸
# =============================================================================

# ìƒ‰ìƒ ì •ì˜
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# ì‚¬ìš©ë²• í‘œì‹œ
show_usage() {
    echo -e "${CYAN}=============================================================================${NC}"
    echo -e "${WHITE}ğŸ“Š ì§„í–‰ ìƒí™© ì—…ë°ì´í„° ì‚¬ìš©ë²•${NC}"
    echo -e "${CYAN}=============================================================================${NC}"
    echo ""
    echo -e "${YELLOW}ê¸°ë³¸ ì‚¬ìš©ë²•:${NC}"
    echo -e "  ./update_progress.sh ${BLUE}[íŒŒì¼ê²½ë¡œ] [ì„¤ëª…]${NC}"
    echo ""
    echo -e "${YELLOW}ì˜ˆì‹œ:${NC}"
    echo -e "  ./update_progress.sh src/lib/cue/CueExtractor.ts \"ë§¥ë½ ì¶”ì¶œ ì—”ì§„ ì™„ì„±\""
    echo -e "  ./update_progress.sh src/components/auth/WebAuthnLogin.tsx \"ë¡œê·¸ì¸ ì»´í¬ë„ŒíŠ¸\""
    echo ""
    echo -e "${YELLOW}ê¸°íƒ€ ëª…ë ¹ì–´:${NC}"
    echo -e "  ./update_progress.sh ${BLUE}status${NC}     # í˜„ì¬ ìƒíƒœë§Œ ë¹ ë¥´ê²Œ í™•ì¸"
    echo -e "  ./update_progress.sh ${BLUE}watch${NC}      # ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘"
    echo -e "  ./update_progress.sh ${BLUE}summary${NC}    # ê°„ë‹¨ ìš”ì•½"
    echo -e "  ./update_progress.sh ${BLUE}next${NC}       # ë‹¤ìŒ í•  ì¼ ì¶”ì²œ"
    echo ""
}

# ê°„ë‹¨ ìƒíƒœ í™•ì¸
quick_status() {
    if [ ! -f "./track_complete_progress.sh" ]; then
        echo -e "${YELLOW}âš ï¸  ë©”ì¸ ì¶”ì  ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € track_complete_progress.shë¥¼ ìƒì„±í•˜ì„¸ìš”.${NC}"
        return 1
    fi
    
    # ê¸°ë³¸ í†µê³„ë§Œ ë¹ ë¥´ê²Œ ê³„ì‚°
    local total_files=0
    local completed_files=0
    
    # í•µì‹¬ íŒŒì¼ë“¤ë§Œ ì²´í¬
    declare -a core_files=(
        "src/lib/config/index.ts"
        "src/auth/webauthn/client.ts"
        "src/lib/cue/CueExtractor.ts"
        "src/types/cue.ts"
        "src/database/supabase/client.ts"
        "src/app/page.tsx"
        "src/app/layout.tsx"
    )
    
    echo -e "${BLUE}ğŸš€ ë¹ ë¥¸ ìƒíƒœ í™•ì¸${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    for file in "${core_files[@]}"; do
        total_files=$((total_files + 1))
        if [ -f "$file" ] && [ $(wc -c < "$file" 2>/dev/null || echo "0") -gt 100 ]; then
            echo -e "${GREEN}âœ…${NC} $file"
            completed_files=$((completed_files + 1))
        else
            echo -e "${YELLOW}â³${NC} $file"
        fi
    done
    
    local percentage=$((completed_files * 100 / total_files))
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WHITE}í•µì‹¬ íŒŒì¼ ì§„í–‰ë¥ : ${GREEN}$completed_files${NC}${WHITE}/$total_files (${percentage}%)${NC}"
}

# íŒŒì¼ ì¶”ê°€ ì•Œë¦¼
add_file_notification() {
    local file_path=$1
    local description=$2
    
    if [ -f "$file_path" ]; then
        local size=$(wc -c < "$file_path" 2>/dev/null || echo "0")
        echo -e "${GREEN}ğŸ‰ íŒŒì¼ ì¶”ê°€ ì™„ë£Œ!${NC}"
        echo -e "   ğŸ“ íŒŒì¼: ${CYAN}$file_path${NC}"
        echo -e "   ğŸ“ ì„¤ëª…: $description"
        echo -e "   ğŸ“Š í¬ê¸°: ${size} bytes"
        echo -e "   â° ì‹œê°„: $(date '+%H:%M:%S')"
        
        # ë©”ì¸ ì¶”ì ê¸° ì‹¤í–‰í•´ì„œ ì—…ë°ì´íŠ¸ëœ ìƒíƒœ í™•ì¸
        echo -e "\n${BLUE}ğŸ“Š ì—…ë°ì´íŠ¸ëœ ì „ì²´ ìƒí™©:${NC}"
        if [ -f "./track_complete_progress.sh" ]; then
            ./track_complete_progress.sh | tail -10
        else
            echo -e "${YELLOW}âš ï¸  ë©”ì¸ ì¶”ì  ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ì „ì²´ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.${NC}"
        fi
        
        # Git ì¶”ê°€ ì œì•ˆ
        echo -e "\n${YELLOW}ğŸ’¡ Gitì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?${NC}"
        echo -e "   git add $file_path"
        echo -e "   git commit -m \"Add: $description\""
        
    else
        echo -e "${YELLOW}âš ï¸  íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $file_path${NC}"
        echo -e "   íŒŒì¼ì„ ë¨¼ì € ìƒì„±í•œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
    fi
}

# ë‹¤ìŒ í•  ì¼ ì¶”ì²œ
suggest_next_tasks() {
    echo -e "${BLUE}ğŸ¯ ë‹¤ìŒ í•  ì¼ ì¶”ì²œ${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    # ìš°ì„ ìˆœìœ„ë³„ ë¯¸ì™„ì„± íŒŒì¼ë“¤ ì²´í¬
    declare -a priority_files=(
        "src/lib/cue/CueExtractor.ts:ğŸ§  Cue ì¶”ì¶œ ì—”ì§„ (ì‹œìŠ¤í…œ í•µì‹¬!)"
        "src/lib/cue/PlatformSyncManager.ts:ğŸ”„ í”Œë«í¼ ë™ê¸°í™”"
        "src/lib/cue/CueApplicationEngine.ts:ğŸ¯ Cue ì ìš© ì—”ì§„"
        "src/types/cue.ts:ğŸ“‹ Cue íƒ€ì… ì •ì˜"
        "src/auth/webauthn/client.ts:ğŸ” WebAuthn í´ë¼ì´ì–¸íŠ¸"
        "src/app/api/webauthn/authenticate/begin/route.ts:ğŸ”‘ ì¸ì¦ ì‹œì‘ API"
        "src/app/api/webauthn/authenticate/complete/route.ts:âœ… ì¸ì¦ ì™„ë£Œ API"
        "src/components/auth/WebAuthnLogin.tsx:ğŸ¨ ë¡œê·¸ì¸ ì»´í¬ë„ŒíŠ¸"
        "src/components/auth/WebAuthnRegister.tsx:ğŸ“ íšŒì›ê°€ì… ì»´í¬ë„ŒíŠ¸"
        "src/database/migrations/001_initial_schema.sql:ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ"
    )
    
    local task_number=1
    for item in "${priority_files[@]}"; do
        IFS=':' read -ra PARTS <<< "$item"
        local file_path="${PARTS[0]}"
        local description="${PARTS[1]}"
        
        if [ ! -f "$file_path" ] || [ $(wc -c < "$file_path" 2>/dev/null || echo "0") -le 100 ]; then
            echo -e "  ${task_number}ï¸âƒ£ $description"
            echo -e "     ğŸ“ ${CYAN}$file_path${NC}"
            task_number=$((task_number + 1))
            
            if [ $task_number -gt 5 ]; then
                break
            fi
        fi
    done
    
    if [ $task_number -eq 1 ]; then
        echo -e "  ğŸ‰ ${GREEN}ëª¨ë“  ìš°ì„  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
        echo -e "     ì´ì œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”:"
        echo -e "     â€¢ npm run dev (ê°œë°œ ì„œë²„ ì‹¤í–‰)"
        echo -e "     â€¢ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹…"
        echo -e "     â€¢ ì¶”ê°€ UI ì»´í¬ë„ŒíŠ¸ ê°œë°œ"
    fi
}

# ìš”ì•½ ë³´ê³ ì„œ
generate_summary() {
    echo -e "${BLUE}ğŸ“Š í”„ë¡œì íŠ¸ ì§„í–‰ ìš”ì•½${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    if [ -f ".progress-status.json" ]; then
        # JSONì—ì„œ ì •ë³´ ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ë²•)
        local overall_progress=$(grep -o '"overallProgress": [0-9]*' .progress-status.json | grep -o '[0-9]*')
        local timestamp=$(grep -o '"timestamp": "[^"]*"' .progress-status.json | cut -d'"' -f4)
        
        echo -e "â° ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timestamp}"
        echo -e "ğŸ“ˆ ì „ì²´ ì§„í–‰ë¥ : ${overall_progress}%"
        
        # ì„¹ì…˜ë³„ ì§„í–‰ë¥  (ê°„ë‹¨íˆ)
        local cue_progress=$(grep -o '"cue": [0-9]*' .progress-status.json | grep -o '[0-9]*')
        local webauthn_progress=$(grep -o '"webauthn": [0-9]*' .progress-status.json | grep -o '[0-9]*')
        local ui_progress=$(grep -o '"ui": [0-9]*' .progress-status.json | grep -o '[0-9]*')
        
        echo -e "ğŸ§  Cue ì‹œìŠ¤í…œ: ${cue_progress}%"
        echo -e "ğŸ” WebAuthn: ${webauthn_progress}%"
        echo -e "ğŸ¨ UI ì»´í¬ë„ŒíŠ¸: ${ui_progress}%"
    else
        echo -e "${YELLOW}âš ï¸  ì§„í–‰ ìƒí™© íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ ì¶”ì ê¸°ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.${NC}"
    fi
    
    echo -e "\n${GREEN}ğŸš€ ë¹ ë¥¸ ì‹¤í–‰ ëª…ë ¹ì–´:${NC}"
    echo -e "   ./track_complete_progress.sh     # ì „ì²´ ìƒí™© í™•ì¸"
    echo -e "   ./update_progress.sh next        # ë‹¤ìŒ í•  ì¼"
    echo -e "   npm run dev                      # ê°œë°œ ì„œë²„ ì‹œì‘"
}

# =============================================================================
# ë©”ì¸ ì‹¤í–‰ ë¡œì§
# =============================================================================

case "$1" in
    "status")
        quick_status
        ;;
    "watch")
        echo -e "${BLUE}ğŸ”„ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘...${NC}"
        echo -e "${YELLOW}Ctrl+Cë¡œ ì¤‘ì§€${NC}"
        watch -n 10 './update_progress.sh status'
        ;;
    "summary")
        generate_summary
        ;;
    "next")
        suggest_next_tasks
        ;;
    "")
        show_usage
        ;;
    *)
        if [ -n "$1" ] && [ -n "$2" ]; then
            # íŒŒì¼ ì¶”ê°€ ëª¨ë“œ
            add_file_notification "$1" "$2"
        else
            echo -e "${YELLOW}âš ï¸  íŒŒì¼ ê²½ë¡œì™€ ì„¤ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
            show_usage
        fi
        ;;
esac